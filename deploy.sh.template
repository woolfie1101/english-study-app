#!/bin/bash

# Google Cloud Run ì¬ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (í…œí”Œë¦¿)
# ì‚¬ìš©ë²•: ./deploy.sh [PROJECT_ID] [SERVICE_NAME]
# 
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í•„ìš”:
# export NEXT_PUBLIC_SUPABASE_URL="your-supabase-url"
# export NEXT_PUBLIC_SUPABASE_ANON_KEY="your-anon-key"
# export SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

PROJECT_ID=${1:-"gen-lang-client-0458093252"}
SERVICE_NAME=${2:-"english-study-app"}
REGION="asia-northeast3"  # ì„œìš¸ ë¦¬ì „

# í™˜ê²½ ë³€ìˆ˜ í™•ì¸
if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ] || [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
    echo "âŒ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
    echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”:"
    echo ""
    echo "export NEXT_PUBLIC_SUPABASE_URL=\"your-supabase-url\""
    echo "export NEXT_PUBLIC_SUPABASE_ANON_KEY=\"your-anon-key\""
    echo "export SUPABASE_SERVICE_ROLE_KEY=\"your-service-role-key\""
    echo ""
    echo "ë˜ëŠ” .env íŒŒì¼ì„ ë¡œë“œí•˜ì„¸ìš”:"
    echo "source .env"
    exit 1
fi

echo "ğŸš€ Google Cloud Runì— ì¬ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
echo "í”„ë¡œì íŠ¸ ID: $PROJECT_ID"
echo "ì„œë¹„ìŠ¤ ì´ë¦„: $SERVICE_NAME"
echo "ë¦¬ì „: $REGION"

# Google Cloud í”„ë¡œì íŠ¸ ì„¤ì •
echo "ğŸ“‹ Google Cloud í”„ë¡œì íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤..."
gcloud config set project $PROJECT_ID

# Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
echo "ğŸ³ Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  í‘¸ì‹œí•©ë‹ˆë‹¤..."
docker buildx build --platform linux/amd64 \
  --build-arg NEXT_PUBLIC_SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL" \
  --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="$NEXT_PUBLIC_SUPABASE_ANON_KEY" \
  --build-arg SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_ROLE_KEY" \
  -t gcr.io/$PROJECT_ID/$SERVICE_NAME \
  --push .

# Cloud Runì— ë°°í¬
echo "ğŸš€ Cloud Runì— ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•©ë‹ˆë‹¤..."
gcloud run deploy $SERVICE_NAME \
  --image gcr.io/$PROJECT_ID/$SERVICE_NAME \
  --platform managed \
  --region $REGION \
  --allow-unauthenticated \
  --port 3000 \
  --memory 1Gi \
  --cpu 1 \
  --max-instances 10 \
  --set-env-vars "NODE_ENV=production,NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL,NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY"

echo "âœ… ì¬ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo "ğŸŒ ì„œë¹„ìŠ¤ URLì„ í™•ì¸í•˜ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:"
echo "gcloud run services describe $SERVICE_NAME --region=$REGION --format='value(status.url)'"

# ì„œë¹„ìŠ¤ URL ìë™ ì¶œë ¥
echo ""
echo "ğŸ”— í˜„ì¬ ì„œë¹„ìŠ¤ URL:"
gcloud run services describe $SERVICE_NAME --region=$REGION --format='value(status.url)'
